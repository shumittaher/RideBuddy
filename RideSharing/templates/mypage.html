{% extends "layout.html" %}

{% block title %}
   : My Page
{% endblock %}

{% block body %}

    <section class="mb-4" id="placement_space">
    </section>

    <h2 class="text-center">Messages for {{ recipient.username|capfirst }}</h2>

    <ul class="boxes mx-auto list-unstyled">
        {% for message in my_messages %}
            <li 
            onclick="handle_message_click(event)" 
            data-message-id="{{message.id}}" 
            data-trip-id="{{message.underlying_trip.id}}" 
            data-booking-id="{{message.underlying_booking.id}}" 
            class="d-flex border rounded booking_row {% if message.read %} mail_read {% endif %}"
            >
                <div class="border m-2 border-5 d-flex justify-content-center align-items-center" 
                style="font-size: 3rem; min-height: 6rem; min-width: 6rem; border-radius: 50%;">
                    {% if message.system_message %}
                        <i class="fa-solid fa-robot"></i>
                    {% else %}
                        <i class="fa-solid fa-user"></i>
                    {% endif %}
                </div>

                <div class="flex-fill p-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>From:</strong> {% if message.sender %}{{ message.sender.username }}{% else %}System Generated{% endif %}
                        </div>
                        <div>
                            {{ message.time_stamp|date:"F j, Y" }}
                        </div>
                    </div>
                    <div>
                        <strong>Message:</strong> {{ message.content }}
                    </div>
                </div>
                    
                <div class="">
                    {{ message.message_type }}
                </div>
            </li>
        {% empty %}
            <li>No messages found.</li>
        {% endfor %}
    </ul>

    <script>

        document.addEventListener('DOMContentLoaded', ()=>{

            placement_space = document.getElementById('placement_space')
            main_section = document.getElementById('main_section')
            
        })
        
        async function handle_message_click(event) {

            collapsed_section = bootstrap.Collapse.getOrCreateInstance(placement_space, {
                toggle: false
            })
            
            const message_body = event.currentTarget

            const { tripId, bookingId, messageId } = message_body.dataset;

            const rendered_trips = await get_trip(tripId, bookingId)
            
            placement_space.innerHTML = rendered_trips
            
            collapsed_section.show()
            main_section.scrollIntoView({ behavior:"smooth"})
            
            const data = await message_put(messageId)
            if (data.read) {
                message_body.classList.add('mail_read')
                console.log(message_body)
            }
        }

        async function get_trip(trip_id, booking_id) {
            const response = await fetch(`/give_trips?trip_id=${trip_id}&booking_trips=false&spec_booking=${booking_id}`)   
            const data = await response.json()

            return data.rendered_trips
        }

        async function message_put(message_id) {
            const response = await fetch('/messages_put',
                {
                    method: 'PUT',
                    headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                    },
                    body: JSON.stringify({
                        'message_id' : message_id,
                    })
                }
            )
            const data = await response.json()
            return data
        }

    </script>

{% endblock %}